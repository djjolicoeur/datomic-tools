name: Publish Snapshot

on:
  push:
    branches: [main]

jobs:
  test-and-publish:
    runs-on: ubuntu-latest
    env:
      CLOJARS_USERNAME: ${{ secrets.CLOJARS_USERNAME }}
      CLOJARS_PASSWORD: ${{ secrets.CLOJARS_PASSWORD }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "11"

      - name: Install Leiningen
        uses: DeLaGuardo/setup-clojure@12.1
        with:
          lein: "2.11.1"

      - name: Cache Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ hashFiles('project.clj') }}
          restore-keys: ${{ runner.os }}-m2-

      - name: Fetch dependencies
        run: lein deps

      - name: Run tests
        run: lein test

      - name: Configure Clojars credentials
        run: |
          mkdir -p ~/.lein
          cat <<EOF > ~/.lein/credentials.clj
          {"https://repo.clojars.org" {:username "${CLOJARS_USERNAME}" :password "${CLOJARS_PASSWORD}"}}
          EOF
          chmod 600 ~/.lein/credentials.clj

      - name: Deploy snapshot to Clojars
        run: lein deploy clojars
